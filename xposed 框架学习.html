<!DOCTYPE html><html><head><title>xposed 框架学习</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'></head><body><div id='preview-contents' class='note-content'>
                        <div id="wmd-preview" class="preview-content"></div>
                    <div id="wmd-preview-section-5" class="wmd-preview-section preview-content"></div><div id="wmd-preview-section-11880" class="wmd-preview-section preview-content">

<h2 id="xposed-框架学习">xposed 框架学习</h2>

<blockquote>
  <p>一直都是看别人的都不敢自己写，总是觉得自己很菜。但是领导说写写比较容易记住，然后就写写了。有什么不对的地方请知道下。</p>
</blockquote>

</div><div id="wmd-preview-section-12065" class="wmd-preview-section preview-content">

<h3 id="一hook流程分析">一、hook流程分析</h3></div><div id="wmd-preview-section-5746" class="wmd-preview-section preview-content">

<h4 id="1先看下常用的-函数">1.先看下常用的 函数</h4></div><div id="wmd-preview-section-5759" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs ocaml">findAndHookMethod(<span class="hljs-type">ActivityThread</span>.<span class="hljs-keyword">class</span>, <span class="hljs-string">"handleBindApplication"</span>, <span class="hljs-string">"android.app.ActivityThread.AppBindData"</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">XC_MethodHook</span><span class="hljs-literal">()</span> {}<br></code></pre>

</div><div id="wmd-preview-section-5760" class="wmd-preview-section preview-content">

<h4 id="2当时我就不乐意了-凭什么他这个可以-替换别人的方法很想知道下是怎么做的">2.当时我就不乐意了 凭什么他这个可以 替换别人的方法，很想知道下是怎么做的。</h4>

<p>然后就跟进去看下</p></div><div id="wmd-preview-section-5774" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> XC_MethodHook.<span class="hljs-function">Unhook <span class="hljs-title">findAndHookMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Object... parameterTypesAndCallback)</span> </span>{<br><span class="hljs-keyword">if</span> (parameterTypesAndCallback.length == <span class="hljs-number">0</span> || !(parameterTypesAndCallback[parameterTypesAndCallback.length-<span class="hljs-number">1</span>] <span class="hljs-keyword">instanceof</span> XC_MethodHook))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"no callback defined"</span>);<br><br>XC_MethodHook callback = (XC_MethodHook) parameterTypesAndCallback[parameterTypesAndCallback.length-<span class="hljs-number">1</span>];<br>Method m = findMethodExact(clazz, methodName, getParameterClasses(clazz.getClassLoader(), parameterTypesAndCallback));<br><br><span class="hljs-function"><span class="hljs-keyword">return</span> XposedBridge.<span class="hljs-title">hookMethod</span><span class="hljs-params">(m, callback)</span></span>;<br>}<br></code></pre>

</div><div id="wmd-preview-section-5789" class="wmd-preview-section preview-content">

<h5 id="21我是菜鸟真没怎么看懂大概意思说-通过这个findmethodexact方法-找到这个clazz的method怎么找好吧在进入这个方法findmethodexact看看">2.1我是菜鸟真没怎么看懂，大概意思说 通过这个<strong>findMethodExact</strong>方法 找到这个<strong>clazz</strong>的Method。怎么找？？？好吧在进入这个方法<strong>findMethodExact</strong>看看</h5></div><div id="wmd-preview-section-5819" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod">    public <span class="hljs-keyword">static</span> <span class="hljs-type">Method</span> findMethodExact(<span class="hljs-type">Class</span>&lt;?&gt; clazz, <span class="hljs-type">String</span> methodName, <span class="hljs-type">Class</span>&lt;?&gt;... parameterTypes) {<br>        <span class="hljs-type">StringBuilder</span> sb = new <span class="hljs-type">StringBuilder</span>(clazz.getName());<br>        sb.append('<span class="hljs-comment">#');</span><br>        sb.append(methodName);<br>        sb.append(getParametersString(parameterTypes));<br>        sb.append(<span class="hljs-string">"#exact"</span>);<br>        <span class="hljs-type">String</span> fullMethodName = sb.toString();<br><br>        <span class="hljs-keyword">if</span> (methodCache.containsKey(fullMethodName)) {<br>            <span class="hljs-type">Method</span> <span class="hljs-keyword">method</span> = methodCache.get(fullMethodName);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">method</span> == null)<br>                throw new <span class="hljs-type">NoSuchMethodError</span>(fullMethodName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">method</span>;<br>        }<br><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-type">Method</span> <span class="hljs-keyword">method</span> = clazz.getDeclaredMethod(methodName, parameterTypes);<br>            <span class="hljs-keyword">method</span>.setAccessible(<span class="hljs-literal">true</span>);<br>            methodCache.put(fullMethodName, <span class="hljs-keyword">method</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">method</span>;<br>        } catch (<span class="hljs-type">NoSuchMethodException</span> e) {<br>            methodCache.put(fullMethodName, null);<br>            throw new <span class="hljs-type">NoSuchMethodError</span>(fullMethodName);<br>        }<br>    }<br></code></pre>

<p>我是不知道它讲什么，算了反正就找到了 这个method，OK？ 而且还把这个method 设置成了可见<strong>method.setAccessible(true);</strong>  是这个意思吗？</p>

</div><div id="wmd-preview-section-5820" class="wmd-preview-section preview-content">

<h4 id="3我们回到2这边-看他最后-弄了个-这个-xposedbridgehookmethodm-callback-我们跟进去看看">3.我们回到<strong>2</strong>这边 看他最后 弄了个 这个 <strong>XposedBridge.hookMethod(m, callback);</strong>  我们跟进去看看</h4></div><div id="wmd-preview-section-1457" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs monkey"><span class="hljs-keyword">public</span> static XC_MethodHook.Unhook hookMethod(Member hookMethod, XC_MethodHook callback) {<br> <span class="hljs-keyword">if</span> (!(hookMethod instanceof <span class="hljs-function"><span class="hljs-keyword">Method</span>) &amp;&amp; !(</span>hookMethod instanceof Constructor&lt;?&gt;)) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Only methods and constructors can be hooked: "</span> +      hookMethod.toString());<br>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hookMethod.getDeclaringClass().isInterface()) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Cannot hook interfaces: "</span> + hookMethod.toString());<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Modifier.isAbstract(hookMethod.getModifiers())) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Cannot hook abstract methods: "</span> + hookMethod.toString());<br>        }<br>    boolean newMethod = <span class="hljs-literal">false</span>;<br>    CopyOnWriteSortedSet&lt;XC_MethodHook&gt; callbacks;<br>    synchronized (sHookedMethodCallbacks) {<br>            callbacks = sHookedMethodCallbacks.get(hookMethod);<br>            <span class="hljs-keyword">if</span> (callbacks == <span class="hljs-literal">null</span>) {<br>                callbacks = <span class="hljs-keyword">new</span> CopyOnWriteSortedSet&lt;XC_MethodHook&gt;();<br>                sHookedMethodCallbacks.put(hookMethod, callbacks);<br>                newMethod = <span class="hljs-literal">true</span>;<br>            }<br>        }<br>        callbacks.add(callback);<br>        <span class="hljs-keyword">if</span> (newMethod) {<br>            <span class="hljs-class"><span class="hljs-keyword">Class</span>&lt;?&gt; <span class="hljs-title">declaringClass</span> = <span class="hljs-title">hookMethod</span>.<span class="hljs-title">getDeclaringClass</span>();</span><br>            int slot = (runtime == RUNTIME_DALVIK) ? (int) getIntField(hookMethod, <span class="hljs-string">"slot"</span>) : <span class="hljs-number">0</span>;<br><br>            <span class="hljs-class"><span class="hljs-keyword">Class</span>&lt;?&gt;[] <span class="hljs-title">parameterTypes</span>;</span><br>            <span class="hljs-class"><span class="hljs-keyword">Class</span>&lt;?&gt; <span class="hljs-title">returnType</span>;</span><br>            <span class="hljs-keyword">if</span> (hookMethod instanceof <span class="hljs-function"><span class="hljs-keyword">Method</span>) {</span><br>                parameterTypes = ((<span class="hljs-function"><span class="hljs-keyword">Method</span>) <span class="hljs-title">hookMethod</span>).<span class="hljs-title">getParameterTypes</span>(</span>);<br>                returnType = ((<span class="hljs-function"><span class="hljs-keyword">Method</span>) <span class="hljs-title">hookMethod</span>).<span class="hljs-title">getReturnType</span>(</span>);<br>            } <span class="hljs-keyword">else</span> {<br>                parameterTypes = ((Constructor&lt;?&gt;) hookMethod).getParameterTypes();<br>                returnType = <span class="hljs-literal">null</span>;<br>            }<br><br>            AdditionalHookInfo additionalInfo = <span class="hljs-keyword">new</span> AdditionalHookInfo(callbacks, parameterTypes, returnType);<br>            hookMethodNative(hookMethod, declaringClass, slot, additionalInfo);<br>        }<br><br>        <span class="hljs-keyword">return</span> callback.<span class="hljs-keyword">new</span> Unhook(hookMethod);<br>    }<br></code></pre>

<p>我靠这么多  这你能懂 。。。 让我们删除些没用的看看</p>

</div><div id="wmd-preview-section-5806" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs actionscript">AdditionalHookInfo additionalInfo = <span class="hljs-keyword">new</span> AdditionalHookInfo(callbacks, parameterTypes, returnType);<br>hookMethodNative(hookMethod, declaringClass, slot, additionalInfo);<br></code></pre>

<p>现在好了 它把所有的 信息弄成了个 <strong>additionalInfo</strong> 和<strong>hookMethod</strong> 传下去了 </p>

</div><div id="wmd-preview-section-5839" class="wmd-preview-section preview-content">

<h5 id="31hookmethodnative-那就看看他咯">3.1.<strong>hookMethodNative</strong> 那就看看他咯</h5></div><div id="wmd-preview-section-2339" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod">private native synchronized <span class="hljs-keyword">static</span> <span class="hljs-type">void</span> hookMethodNative(<span class="hljs-type">Member</span> <span class="hljs-keyword">method</span>, <span class="hljs-type">Class</span>&lt;?&gt; declaringClass, <span class="hljs-type">int</span> slot, <span class="hljs-type">Object</span> additionalInfo);<br></code></pre>

<p>你妹啊 native 哭~~~~。据说这个方法在Xposed-master/libxposed_dalvik.cpp 中</p>

</div><div id="wmd-preview-section-3190" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod"><span class="hljs-type">void</span> <span class="hljs-type">XposedBridge_hookMethodNative</span>(<span class="hljs-type">JNIEnv</span>* env, jclass clazz, jobject reflectedMethodIndirect,<br>            jobject declaredClassIndirect, jint slot, jobject additionalInfoIndirect) {<br>    // <span class="hljs-type">Usage</span> errors?<br>    <span class="hljs-keyword">if</span> (declaredClassIndirect == <span class="hljs-type">NULL</span> || reflectedMethodIndirect == <span class="hljs-type">NULL</span>) {<br>        dvmThrowIllegalArgumentException(<span class="hljs-string">"method and declaredClass must not be null"</span>);<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    // <span class="hljs-type">Find</span> the internal representation <span class="hljs-keyword">of</span> the <span class="hljs-keyword">method</span><br>    <span class="hljs-type">ClassObject</span>* declaredClass = (<span class="hljs-type">ClassObject</span>*) dvmDecodeIndirectRef(dvmThreadSelf(), declaredClassIndirect);<br>    <span class="hljs-type">Method</span>* <span class="hljs-keyword">method</span> = dvmSlotToMethod(declaredClass, slot);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">method</span> == <span class="hljs-type">NULL</span>) {<br>        dvmThrowNoSuchMethodError(<span class="hljs-string">"Could not get internal representation for method"</span>);<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    <span class="hljs-keyword">if</span> (isMethodHooked(<span class="hljs-keyword">method</span>)) {<br>        // already hooked<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    // <span class="hljs-type">Save</span> a copy <span class="hljs-keyword">of</span> the original <span class="hljs-keyword">method</span> <span class="hljs-keyword">and</span> other hook info<br>    <span class="hljs-type">XposedHookInfo</span>* hookInfo = (<span class="hljs-type">XposedHookInfo</span>*) calloc(<span class="hljs-number">1</span>, sizeof(<span class="hljs-type">XposedHookInfo</span>));<br>    memcpy(hookInfo, <span class="hljs-keyword">method</span>, sizeof(hookInfo-&gt;originalMethodStruct));<br>    hookInfo-&gt;reflectedMethod = dvmDecodeIndirectRef(dvmThreadSelf(), env-&gt;<span class="hljs-type">NewGlobalRef</span>(reflectedMethodIndirect));<br>    hookInfo-&gt;additionalInfo = dvmDecodeIndirectRef(dvmThreadSelf(), env-&gt;<span class="hljs-type">NewGlobalRef</span>(additionalInfoIndirect));<br><br>    // <span class="hljs-type">Replace</span> <span class="hljs-keyword">method</span> <span class="hljs-keyword">with</span> our own code<br>    <span class="hljs-type">SET_METHOD_FLAG</span>(<span class="hljs-keyword">method</span>, <span class="hljs-type">ACC_NATIVE</span>);<br>    <span class="hljs-keyword">method</span>-&gt;nativeFunc = &amp;hookedMethodCallback;<br>    <span class="hljs-keyword">method</span>-&gt;insns = (<span class="hljs-keyword">const</span> u2*) hookInfo;<br>    <span class="hljs-keyword">method</span>-&gt;registersSize = <span class="hljs-keyword">method</span>-&gt;insSize;<br>    <span class="hljs-keyword">method</span>-&gt;outsSize = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-type">PTR_gDvmJit</span> != <span class="hljs-type">NULL</span>) {<br>        // reset <span class="hljs-type">JIT</span> cache<br>        <span class="hljs-type">char</span> currentValue = *((<span class="hljs-type">char</span>*)<span class="hljs-type">PTR_gDvmJit</span> + <span class="hljs-type">MEMBER_OFFSET_VAR</span>(<span class="hljs-type">DvmJitGlobals</span>,codeCacheFull));<br>        <span class="hljs-keyword">if</span> (currentValue == <span class="hljs-number">0</span> || currentValue == <span class="hljs-number">1</span>) {<br>            <span class="hljs-type">MEMBER_VAL</span>(<span class="hljs-type">PTR_gDvmJit</span>, <span class="hljs-type">DvmJitGlobals</span>, codeCacheFull) = <span class="hljs-literal">true</span>;<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-type">ALOGE</span>(<span class="hljs-string">"Unexpected current value for codeCacheFull: %d"</span>, currentValue);<br>        }<br>    }<br>}<br><br></code></pre>

<p>事实告诉我们看到这么长的不用紧张 ，慢慢看总能提取有用的信息 <strong>isMethodHooked(method)</strong> 说如果hook了就直接反回了</p>

<p>同 他这个方法是这么判断的  <strong>return (method-&gt;nativeFunc == &amp;hookedMethodCallback);</strong> 结合下面的 就清楚了 </p></div><div id="wmd-preview-section-5742" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod">    <span class="hljs-keyword">method</span>-&gt;nativeFunc = &amp;hookedMethodCallback;<br>    <span class="hljs-keyword">method</span>-&gt;insns = (<span class="hljs-keyword">const</span> u2*) hookInfo;<br>    <span class="hljs-keyword">method</span>-&gt;registersSize = <span class="hljs-keyword">method</span>-&gt;insSize;<br>    <span class="hljs-keyword">method</span>-&gt;outsSize = <span class="hljs-number">0</span>;<br></code></pre>

<p>关键是将  <strong>method-&gt;nativeFunc = &amp;hookedMethodCallback;</strong> 如果这个method 被指定到 <strong>hookedMethodCallback</strong> 这个函数就算是hook到了  <strong>&amp;hookedMethodCallback</strong> 相信我 这个应该是个函数指针 到这个函数看看 这个函数怎么 把原来的 函数接上的  而且还会加入 <strong>beforeHookedMethod</strong>和<strong>afterHookedMethod</strong> 真不知道是咋么弄的 。。。。  可是这个 Method类真的是 How old are you，怎么老是你。都不知道是什么， 在 android 源码的Object 类中找到了。幸好我是过四级的，裸考真的，当时忙着电子设计大赛就没空读书，结果随便去考下结果433 过了四级。大概翻译下。</p></div><div id="wmd-preview-section-6387" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod"><br>/*<br> * A <span class="hljs-keyword">method</span>.  <span class="hljs-type">We</span> create one <span class="hljs-keyword">of</span> these <span class="hljs-keyword">for</span> every <span class="hljs-keyword">method</span> <span class="hljs-keyword">in</span> every class<br> * we load, so <span class="hljs-keyword">try</span> to keep the size to a minimum.<br> *<br> * <span class="hljs-type">Much</span> <span class="hljs-keyword">of</span> this comes <span class="hljs-keyword">from</span> <span class="hljs-keyword">and</span> could be accessed <span class="hljs-keyword">in</span> the data held <span class="hljs-keyword">in</span> <span class="hljs-literal">shared</span><br> * memory.  <span class="hljs-type">We</span> hold it all together here <span class="hljs-keyword">for</span> speed.  <span class="hljs-type">Everything</span> but the<br> * pointers could be held <span class="hljs-keyword">in</span> a <span class="hljs-literal">shared</span> table generated by the optimizer;<br> * <span class="hljs-keyword">if</span> we're willing to convert them to offsets <span class="hljs-keyword">and</span> take the performance<br> * hit (e.g. <span class="hljs-string">"meth-&gt;insns"</span> becomes <span class="hljs-string">"baseAddr + meth-&gt;insnsOffset"</span>) we<br> * could move everything but <span class="hljs-string">"nativeFunc"</span>.<br> */<br>struct <span class="hljs-type">Method</span> {<br>    /* the class we are a part <span class="hljs-keyword">of</span> */<br>    <span class="hljs-type">ClassObject</span>*    clazz;<br><br>    /* access flags; low <span class="hljs-number">16</span> bits are defined by spec (could be u2?) */<br>    u4              accessFlags;<br><br>    /*<br>     * <span class="hljs-type">For</span> concrete virtual methods, this <span class="hljs-keyword">is</span> the offset <span class="hljs-keyword">of</span> the <span class="hljs-keyword">method</span><br>     * <span class="hljs-keyword">in</span> <span class="hljs-string">"vtable"</span>.<br>     *<br>     * <span class="hljs-type">For</span> abstract methods <span class="hljs-keyword">in</span> an <span class="hljs-keyword">interface</span> class, this <span class="hljs-keyword">is</span> the offset<br>     * <span class="hljs-keyword">of</span> the <span class="hljs-keyword">method</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"iftable[n]-&gt;methodIndexArray"</span>.<br>     */<br>    u2             methodIndex;<br><br>    /*<br>     * <span class="hljs-type">Method</span> bounds; <span class="hljs-keyword">not</span> needed <span class="hljs-keyword">for</span> an abstract <span class="hljs-keyword">method</span>.<br>     *<br>     * <span class="hljs-type">For</span> a native <span class="hljs-keyword">method</span>, we compute the size <span class="hljs-keyword">of</span> the argument list, <span class="hljs-keyword">and</span><br>     * <span class="hljs-type">set</span> <span class="hljs-string">"insSize"</span> <span class="hljs-keyword">and</span> <span class="hljs-string">"registerSize"</span> equal to it.<br>     */<br>    u2              registersSize;  /* ins + locals */<br>    u2              outsSize;<br>    u2              insSize;<br><br>    /* <span class="hljs-keyword">method</span> name, e.g. <span class="hljs-string">"&lt;init&gt;"</span> <span class="hljs-keyword">or</span> <span class="hljs-string">"eatLunch"</span> */<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>*     name;<br><br>    /*<br>     * <span class="hljs-type">Method</span> prototype descriptor <span class="hljs-type">string</span> (<span class="hljs-keyword">return</span> <span class="hljs-keyword">and</span> argument types).<br>     *<br>     * <span class="hljs-type">TODO</span>: <span class="hljs-type">This</span> currently must specify the <span class="hljs-type">DexFile</span> <span class="hljs-keyword">as</span> well <span class="hljs-keyword">as</span> the proto_ids<br>     * index, because generated <span class="hljs-type">Proxy</span> classes don't have a <span class="hljs-type">DexFile</span>.  <span class="hljs-type">We</span> can<br>     * remove the <span class="hljs-type">DexFile</span>* <span class="hljs-keyword">and</span> reduce the size <span class="hljs-keyword">of</span> this struct <span class="hljs-keyword">if</span> we generate<br>     * a <span class="hljs-type">DEX</span> <span class="hljs-keyword">for</span> proxies.<br>     */<br>    <span class="hljs-type">DexProto</span>        prototype;<br><br>    /* short-form <span class="hljs-keyword">method</span> descriptor <span class="hljs-type">string</span> */<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>*     shorty;<br><br>    /*<br>     * <span class="hljs-type">The</span> remaining items are <span class="hljs-keyword">not</span> used <span class="hljs-keyword">for</span> abstract <span class="hljs-keyword">or</span> native methods.<br>     * (<span class="hljs-type">JNI</span> <span class="hljs-keyword">is</span> currently hijacking <span class="hljs-string">"insns"</span> <span class="hljs-keyword">as</span> a function <span class="hljs-type">pointer</span>, <span class="hljs-type">set</span><br>     * after the first call.  <span class="hljs-type">For</span> internal-native this stays null.)<br>     */<br><br>    /* the actual code */<br>    <span class="hljs-keyword">const</span> u2*       insns;          /* instructions, <span class="hljs-keyword">in</span> memory-mapped .dex */<br><br>    /* cached <span class="hljs-type">JNI</span> argument <span class="hljs-keyword">and</span> <span class="hljs-keyword">return</span>-<span class="hljs-keyword">type</span> hints */<br>    <span class="hljs-type">int</span>             jniArgInfo;<br><br>    /*<br>     * <span class="hljs-type">Native</span> <span class="hljs-keyword">method</span> <span class="hljs-keyword">ptr</span>; could be actual function <span class="hljs-keyword">or</span> a <span class="hljs-type">JNI</span> bridge.  <span class="hljs-type">We</span><br>     * don't currently discriminate between <span class="hljs-type">DalvikBridgeFunc</span> <span class="hljs-keyword">and</span><br>     * <span class="hljs-type">DalvikNativeFunc</span>; the former takes an argument superset (i.e. two<br>     * extra args) which will be ignored.  <span class="hljs-type">If</span> necessary we can use<br>     * insns==<span class="hljs-type">NULL</span> to detect <span class="hljs-type">JNI</span> bridge vs. internal native.<br>     */<br>    <span class="hljs-type">DalvikBridgeFunc</span> nativeFunc;<br><br>    /*<br>     * <span class="hljs-type">Register</span> map data, <span class="hljs-keyword">if</span> available.  <span class="hljs-type">This</span> will point into the <span class="hljs-type">DEX</span> file<br>     * <span class="hljs-keyword">if</span> the data was computed during pre-verification, <span class="hljs-keyword">or</span> into the<br>     * linear alloc area <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>.<br>     */<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">RegisterMap</span>* registerMap;<br><br>    /* <span class="hljs-type">set</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">method</span> was called during <span class="hljs-keyword">method</span> profiling */<br>    <span class="hljs-type">bool</span>            inProfile;<br>};<br><br></code></pre>

<p>看懂啦？  我也没看懂。但是没关系我们知道它会调用 <strong>method-&gt;nativeFunc = &amp;hookedMethodCallback;</strong> 看下啊 </p>

</div><div id="wmd-preview-section-7941" class="wmd-preview-section preview-content">

<h4 id="4hookedmethodcallback-看看这个吧">4.hookedMethodCallback 看看这个吧</h4>

<p>前面都是一些转换什么的  <br>
dvmCallMethod(self, xposedHandleHookedMethod, NULL, &amp;result,  originalReflected, (int) original, additionalInfo,..） <br>
在这里调用了<strong>xposedHandleHookedMethod</strong> 我先告诉你这个是调回java的XposedBridge类中handleHookedMethod函数; 然后你们自己看下为什么会是xposedHandleHookedMethod 等于 XposedBridge类中handleHookedMethod。</p></div><div id="wmd-preview-section-6664" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod">/** <span class="hljs-type">This</span> <span class="hljs-keyword">is</span> called <span class="hljs-keyword">when</span> a hooked <span class="hljs-keyword">method</span> <span class="hljs-keyword">is</span> executed. */<br><span class="hljs-type">void</span> hookedMethodCallback(<span class="hljs-keyword">const</span> u4* args, <span class="hljs-type">JValue</span>* pResult, <span class="hljs-keyword">const</span> <span class="hljs-type">Method</span>* <span class="hljs-keyword">method</span>, ::<span class="hljs-type">Thread</span>* self) {<br>    <span class="hljs-keyword">if</span> (!isMethodHooked(<span class="hljs-keyword">method</span>)) {<br>        dvmThrowNoSuchMethodError(<span class="hljs-string">"Could not find Xposed original method - how did you even get here?"</span>);<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    <span class="hljs-type">XposedHookInfo</span>* hookInfo = (<span class="hljs-type">XposedHookInfo</span>*) <span class="hljs-keyword">method</span>-&gt;insns;<br>    <span class="hljs-type">Method</span>* original = (<span class="hljs-type">Method</span>*) hookInfo;<br>    <span class="hljs-type">Object</span>* originalReflected = hookInfo-&gt;reflectedMethod;<br>    <span class="hljs-type">Object</span>* additionalInfo = hookInfo-&gt;additionalInfo;<br><br>    // convert/box arguments<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>* desc = &amp;<span class="hljs-keyword">method</span>-&gt;shorty[<span class="hljs-number">1</span>]; // [<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> the <span class="hljs-keyword">return</span> <span class="hljs-keyword">type</span>.<br>    <span class="hljs-type">Object</span>* thisObject = <span class="hljs-type">NULL</span>;<br>    size_t srcIndex = <span class="hljs-number">0</span>;<br>    size_t dstIndex = <span class="hljs-number">0</span>;<br><br>    // <span class="hljs-keyword">for</span> non-<span class="hljs-keyword">static</span> methods determine the <span class="hljs-string">"this"</span> <span class="hljs-type">pointer</span><br>    <span class="hljs-keyword">if</span> (!dvmIsStaticMethod(original)) {<br>        thisObject = (<span class="hljs-type">Object</span>*) args[<span class="hljs-number">0</span>];<br>        srcIndex++;<br>    }<br><br>    <span class="hljs-type">ArrayObject</span>* argsArray = dvmAllocArrayByClass(objectArrayClass, strlen(<span class="hljs-keyword">method</span>-&gt;shorty) - <span class="hljs-number">1</span>, <span class="hljs-type">ALLOC_DEFAULT</span>);<br>    <span class="hljs-keyword">if</span> (argsArray == <span class="hljs-type">NULL</span>) {<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    <span class="hljs-keyword">while</span> (*desc != '\<span class="hljs-number">0</span>') {<br>        <span class="hljs-type">char</span> descChar = *(desc++);<br>        <span class="hljs-type">JValue</span> value;<br>        <span class="hljs-type">Object</span>* obj;<br><br>        switch (descChar) {<br>        <span class="hljs-keyword">case</span> 'Z':<br>        <span class="hljs-keyword">case</span> 'C':<br>        <span class="hljs-keyword">case</span> 'F':<br>        <span class="hljs-keyword">case</span> 'B':<br>        <span class="hljs-keyword">case</span> 'S':<br>        <span class="hljs-keyword">case</span> 'I':<br>            value.i = args[srcIndex++];<br>            obj = (<span class="hljs-type">Object</span>*) dvmBoxPrimitive(value, dvmFindPrimitiveClass(descChar));<br>            dvmReleaseTrackedAlloc(obj, self);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> 'D':<br>        <span class="hljs-keyword">case</span> 'J':<br>            value.j = dvmGetArgLong(args, srcIndex);<br>            srcIndex += <span class="hljs-number">2</span>;<br>            obj = (<span class="hljs-type">Object</span>*) dvmBoxPrimitive(value, dvmFindPrimitiveClass(descChar));<br>            dvmReleaseTrackedAlloc(obj, self);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> '[':<br>        <span class="hljs-keyword">case</span> 'L':<br>            obj  = (<span class="hljs-type">Object</span>*) args[srcIndex++];<br>            <span class="hljs-keyword">break</span>;<br>        default:<br>            <span class="hljs-type">ALOGE</span>(<span class="hljs-string">"Unknown method signature description character: %c"</span>, descChar);<br>            obj = <span class="hljs-type">NULL</span>;<br>            srcIndex++;<br>        }<br>        setObjectArrayElement(argsArray, dstIndex++, obj);<br>    }<br><br>    // call the <span class="hljs-type">Java</span> handler function<br>    <span class="hljs-type">JValue</span> <span class="hljs-literal">result</span>;<br>    dvmCallMethod(self, xposedHandleHookedMethod, <span class="hljs-type">NULL</span>, &amp;<span class="hljs-literal">result</span>,<br>        originalReflected, (<span class="hljs-type">int</span>) original, additionalInfo, thisObject, argsArray);<br><br>    dvmReleaseTrackedAlloc(argsArray, self);<br><br>    // exceptions are thrown to the caller<br>    <span class="hljs-keyword">if</span> (dvmCheckException(self)) {<br>        <span class="hljs-keyword">return</span>;<br>    }<br><br>    // <span class="hljs-keyword">return</span> <span class="hljs-literal">result</span> <span class="hljs-keyword">with</span> proper <span class="hljs-keyword">type</span><br>    <span class="hljs-type">ClassObject</span>* returnType = dvmGetBoxedReturnType(<span class="hljs-keyword">method</span>);<br>    <span class="hljs-keyword">if</span> (returnType-&gt;primitiveType == <span class="hljs-type">PRIM_VOID</span>) {<br>        // ignored<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-literal">result</span>.l == <span class="hljs-type">NULL</span>) {<br>        <span class="hljs-keyword">if</span> (dvmIsPrimitiveClass(returnType)) {<br>            dvmThrowNullPointerException(<span class="hljs-string">"null result when primitive expected"</span>);<br>        }<br>        pResult-&gt;l = <span class="hljs-type">NULL</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">if</span> (!dvmUnboxPrimitive(<span class="hljs-literal">result</span>.l, returnType, pResult)) {<br>            dvmThrowClassCastException(<span class="hljs-literal">result</span>.l-&gt;clazz, returnType);<br>        }<br>    }<br>}<br></code></pre></div><div id="wmd-preview-section-10782" class="wmd-preview-section preview-content">

<h4 id="5xposedbridge类中handlehookedmethod">5.XposedBridge类中handleHookedMethod</h4>

<p>终于回到java了 好爽,不对，，，，，  你妹啊 刚进函数就又遇到native  哦 前面两个<strong>invokeOriginalMethodNative</strong> 好像意思是说 没有hook成功或者 null什么的就调用 <strong>invokeOriginalMethodNative</strong>  就是原来的方法咯。先不看这个native。先看下面的说 <strong>((XC_MethodHook) callbacksSnapshot[beforeIdx]).beforeHookedMethod(param)</strong>和<strong>((XC_MethodHook) callbacksSnapshot[afterIdx]).afterHookedMethod(param)</strong>就是调用我们的“病毒代码了”。这样应该差不多了解了整个hook的过程。然我们最后看下它调用<strong>invokeOriginalMethodNative</strong> 的原理</p></div><div id="wmd-preview-section-10943" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod">/**<br>     * <span class="hljs-type">This</span> <span class="hljs-keyword">method</span> <span class="hljs-keyword">is</span> called <span class="hljs-keyword">as</span> a replacement <span class="hljs-keyword">for</span> hooked methods.<br>     */<br>    private <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> handleHookedMethod(<span class="hljs-type">Member</span> <span class="hljs-keyword">method</span>, <span class="hljs-type">int</span> originalMethodId, <span class="hljs-type">Object</span> additionalInfoObj,<br>            <span class="hljs-type">Object</span> thisObject, <span class="hljs-type">Object</span>[] args) throws <span class="hljs-type">Throwable</span> {<br>        <span class="hljs-type">AdditionalHookInfo</span> additionalInfo = (<span class="hljs-type">AdditionalHookInfo</span>) additionalInfoObj;<br><br>        <span class="hljs-keyword">if</span> (disableHooks) {<br>            <span class="hljs-keyword">try</span> {<br>                <span class="hljs-keyword">return</span> invokeOriginalMethodNative(<span class="hljs-keyword">method</span>, originalMethodId, additionalInfo.parameterTypes,<br>                        additionalInfo.returnType, thisObject, args);<br>            } catch (<span class="hljs-type">InvocationTargetException</span> e) {<br>                throw e.getCause();<br>            }<br>        }<br><br>        <span class="hljs-type">Object</span>[] callbacksSnapshot = additionalInfo.callbacks.getSnapshot();<br>        final <span class="hljs-type">int</span> callbacksLength = callbacksSnapshot.length;<br>        <span class="hljs-keyword">if</span> (callbacksLength == <span class="hljs-number">0</span>) {<br>            <span class="hljs-keyword">try</span> {<br>                <span class="hljs-keyword">return</span> invokeOriginalMethodNative(<span class="hljs-keyword">method</span>, originalMethodId, additionalInfo.parameterTypes,<br>                        additionalInfo.returnType, thisObject, args);<br>            } catch (<span class="hljs-type">InvocationTargetException</span> e) {<br>                throw e.getCause();<br>            }<br>        }<br><br>        <span class="hljs-type">MethodHookParam</span> param = new <span class="hljs-type">MethodHookParam</span>();<br>        param.<span class="hljs-keyword">method</span> = <span class="hljs-keyword">method</span>;<br>        param.thisObject = thisObject;<br>        param.args = args;<br><br>        // call <span class="hljs-string">"before method"</span> callbacks<br>        <span class="hljs-type">int</span> beforeIdx = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> {<br>            <span class="hljs-keyword">try</span> {<br>                ((<span class="hljs-type">XC_MethodHook</span>) callbacksSnapshot[beforeIdx]).beforeHookedMethod(param);<br>            } catch (<span class="hljs-type">Throwable</span> t) {<br>                <span class="hljs-type">XposedBridge</span>.log(t);<br><br>                // reset <span class="hljs-literal">result</span> (ignoring what the unexpectedly exiting callback did)<br>                param.setResult(null);<br>                param.returnEarly = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">continue</span>;<br>            }<br><br>            <span class="hljs-keyword">if</span> (param.returnEarly) {<br>                // skip remaining <span class="hljs-string">"before"</span> callbacks <span class="hljs-keyword">and</span> corresponding <span class="hljs-string">"after"</span> callbacks<br>                beforeIdx++;<br>                <span class="hljs-keyword">break</span>;<br>            }<br>        } <span class="hljs-keyword">while</span> (++beforeIdx &lt; callbacksLength);<br><br>        // call original <span class="hljs-keyword">method</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> requested otherwise<br>        <span class="hljs-keyword">if</span> (!param.returnEarly) {<br>            <span class="hljs-keyword">try</span> {<br>                param.setResult(invokeOriginalMethodNative(<span class="hljs-keyword">method</span>, originalMethodId,<br>                        additionalInfo.parameterTypes, additionalInfo.returnType, param.thisObject, param.args));<br>            } catch (<span class="hljs-type">InvocationTargetException</span> e) {<br>                param.setThrowable(e.getCause());<br>            }<br>        }<br><br>        // call <span class="hljs-string">"after method"</span> callbacks<br>        <span class="hljs-type">int</span> afterIdx = beforeIdx - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">do</span> {<br>            <span class="hljs-type">Object</span> lastResult =  param.getResult();<br>            <span class="hljs-type">Throwable</span> lastThrowable = param.getThrowable();<br><br>            <span class="hljs-keyword">try</span> {<br>                ((<span class="hljs-type">XC_MethodHook</span>) callbacksSnapshot[afterIdx]).afterHookedMethod(param);<br>            } catch (<span class="hljs-type">Throwable</span> t) {<br>                <span class="hljs-type">XposedBridge</span>.log(t);<br><br>                // reset to last <span class="hljs-literal">result</span> (ignoring what the unexpectedly exiting callback did)<br>                <span class="hljs-keyword">if</span> (lastThrowable == null)<br>                    param.setResult(lastResult);<br>                <span class="hljs-keyword">else</span><br>                    param.setThrowable(lastThrowable);<br>            }<br>        } <span class="hljs-keyword">while</span> (--afterIdx &gt;= <span class="hljs-number">0</span>);<br><br>        // <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">if</span> (param.hasThrowable())<br>            throw param.getThrowable();<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> param.getResult();<br>    }<br><br></code></pre>

</div><div id="wmd-preview-section-11217" class="wmd-preview-section preview-content">

<h4 id="6invokeoriginalmethodnative-是怎么弄的应该很简单的">6.invokeOriginalMethodNative 是怎么弄的应该很简单的</h4>

</div><div id="wmd-preview-section-12131" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs nimrod"><span class="hljs-type">void</span> <span class="hljs-type">XposedBridge_invokeOriginalMethodNative</span>(<span class="hljs-keyword">const</span> u4* args, <span class="hljs-type">JValue</span>* pResult,<br>            <span class="hljs-keyword">const</span> <span class="hljs-type">Method</span>* <span class="hljs-keyword">method</span>, ::<span class="hljs-type">Thread</span>* self) {<br>    <span class="hljs-type">Method</span>* meth = (<span class="hljs-type">Method</span>*) args[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">if</span> (meth == <span class="hljs-type">NULL</span>) {<br>        meth = dvmGetMethodFromReflectObj((<span class="hljs-type">Object</span>*) args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (isMethodHooked(meth)) {<br>            meth = (<span class="hljs-type">Method</span>*) meth-&gt;insns;<br>        }<br>    }<br>    <span class="hljs-type">ArrayObject</span>* params = (<span class="hljs-type">ArrayObject</span>*) args[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">ClassObject</span>* returnType = (<span class="hljs-type">ClassObject</span>*) args[<span class="hljs-number">3</span>];<br>    <span class="hljs-type">Object</span>* thisObject = (<span class="hljs-type">Object</span>*) args[<span class="hljs-number">4</span>]; // null <span class="hljs-keyword">for</span> <span class="hljs-keyword">static</span> methods<br>    <span class="hljs-type">ArrayObject</span>* argList = (<span class="hljs-type">ArrayObject</span>*) args[<span class="hljs-number">5</span>];<br><br>    // invoke the <span class="hljs-keyword">method</span><br>    pResult-&gt;l = dvmInvokeMethod(thisObject, meth, argList, params, returnType, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span>;<br>}<br></code></pre>

<p>看上面的代码就这么简单  看不懂没关系 懂得待该意思就可以了 然后实践项目的时候就会知道了</p></div><div id="wmd-preview-section-12851" class="wmd-preview-section preview-content">

<h3 id="二注册流程分析">二、注册流程分析</h3>

<p>稍微看了下<strong>loadmodule()</strong> 有个地方卡住了 明天再看</p></div><div id="wmd-preview-section-footnotes" class="preview-content"></div></div></body></html>